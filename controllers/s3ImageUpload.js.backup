const express = require("express");
const { authenticateDoctorToken } = require("../middleware/doctorAuth");
const { upload, deleteImageFromS3 } = require("../services/aws/imageUpload");

const router = express.Router();

// Upload doctor profile image to S3
router.post("/doctor-profile", authenticateDoctorToken, (req, res, next) => {
  console.log("S3 upload attempt - User:", req.user?.email);
  console.log("Content-Type:", req.headers["content-type"]);

  upload.single("image")(req, res, (err) => {
    if (err) {
      console.error("Multer/S3 error:", err);
      return res.status(400).json({
        success: false,
        message: "File upload error",
        error: err.message,
      });
    }

    try {
      if (!req.file) {
        console.log("No file received");
        return res.status(400).json({
          success: false,
          message: "No image file provided",
        });
      }

      console.log("File uploaded successfully:", req.file.key);

      const imageUrl = req.file.location; // S3 URL from multer-s3
      const fileSize = req.file.size;
      const fileName = req.file.key;

      res.json({
        success: true,
        message: "Image uploaded successfully",
        data: {
          imageUrl,
          fileName,
          fileSize,
        },
      });
    } catch (error) {
      console.error("Error processing uploaded image:", error);
      res.status(500).json({
        success: false,
        message: "Failed to process uploaded image",
        error: error.message,
      });
    }
  });
});

// Delete image from S3
router.delete("/image", authenticateDoctorToken, async (req, res) => {
  try {
    const { imageUrl } = req.body;

    if (!imageUrl) {
      return res.status(400).json({
        success: false,
        message: "Image URL is required",
      });
    }

    await deleteImageFromS3(imageUrl);

    res.json({
      success: true,
      message: "Image deleted successfully",
    });
  } catch (error) {
    console.error("Error deleting image:", error);
    res.status(500).json({
      success: false,
      message: "Failed to delete image",
      error: error.message,
    });
  }
});

module.exports = router;
